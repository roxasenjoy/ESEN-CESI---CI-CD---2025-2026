name: CI/CD Restaurant

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 1 : Tests (CI)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test:
    runs-on: ubuntu-latest
    steps:
      - name: RÃ©cupÃ©rer le code
        uses: actions/checkout@v4

      - name: Installer Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Installer les dÃ©pendances
        run: npm install

      - name: Lancer le linting
        run: npm run lint

      - name: Lancer les tests
        run: npm test

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 2 : DÃ©ploiement (CD)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: RÃ©cupÃ©rer le code
        uses: actions/checkout@v4

      - name: Configurer GitHub Pages
        uses: actions/configure-pages@v4

      - name: Uploader les fichiers
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: DÃ©ployer sur GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Health Check - VÃ©rifier que le site rÃ©pond
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      # On attend 30 secondes que GitHub Pages soit vraiment dÃ©ployÃ©
      - name: Attendre que le site soit prÃªt
        run: sleep 30

      # On vÃ©rifie que le site rÃ©pond avec un code HTTP 200
      - name: VÃ©rifier que le restaurant est ouvert
        run: |
          echo "ğŸ” VÃ©rification du site..."
          
          # RÃ©cupÃ©rer l'URL du dÃ©ploiement
          SITE_URL="${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“ URL Ã  vÃ©rifier : $SITE_URL"
          
          # VÃ©rifier que le site rÃ©pond avec un code 200
          # -s : mode silencieux
          # -o /dev/null : ignore le contenu de la rÃ©ponse
          # -w "%{http_code}" : affiche uniquement le code HTTP
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL")
          echo "ğŸ“Š Code HTTP : $HTTP_STATUS"
          
          # Si le code est 200, le site fonctionne
          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "âœ… Le restaurant est ouvert ! Le site rÃ©pond correctement."
          else
            echo "âŒ Erreur ! Le site ne rÃ©pond pas (code: $HTTP_STATUS)"
            exit 1
          fi

      # On vÃ©rifie que le contenu est correct (optionnel)
      - name: VÃ©rifier le contenu du site
        run: |
          SITE_URL="${{ steps.deployment.outputs.page_url }}"
          CONTENT=$(curl -s "$SITE_URL")
          
          # VÃ©rifier que le titre "Chez Andrew" est prÃ©sent dans la page
          if echo "$CONTENT" | grep -q "Chez Andrew"; then
            echo "âœ… Le contenu est correct - 'Chez Andrew' trouvÃ©"
          else
            echo "âŒ Le contenu ne semble pas correct"
            exit 1
          fi